!function(d,c){"function"==typeof define&&define.amd?define(c):d.BackgroundCheck=c(d)}(this,function(){function ap(b){if(void 0===b||void 0===b.targets){throw"Missing attributes"}L.debug=am(b.debug,!1),L.debugOverlay=am(b.debugOverlay,!1),L.targets=aj(b.targets),L.images=aj(b.images||"img",!0),L.changeParent=am(b.changeParent,!1),L.threshold=am(b.threshold,50),L.minComplexity=am(b.minComplexity,30),L.minOverlap=am(b.minOverlap,50),L.windowEvents=am(b.windowEvents,!0),L.maxDuration=am(b.maxDuration,500),L.mask=am(b.mask,{r:0,g:255,b:0}),L.classes=am(b.classes,{dark:"background--dark",light:"background--light",complex:"background--complex"}),void 0===X&&(ai(),X&&(V.style.position="fixed",V.style.top="0px",V.style.left="0px",V.style.width="100%",V.style.height="100%",window.addEventListener(N,K.bind(null,function(){af(),M()})),window.addEventListener("scroll",K.bind(null,M)),af(),M()))}function ao(){X=null,V=null,T=null,L={},R&&clearTimeout(R)}function an(b){I("debug")&&console.log(b)}function am(d,c){return al(d,typeof c),void 0===d?c:d}function al(d,c){if(void 0!==d&&typeof d!==c){throw"Incorrect attribute type"}}function ak(g){for(var c,j,i=[],h=0;h<g.length;h++){if(c=g[h],i.push(c),"IMG"!==c.tagName){if(j=window.getComputedStyle(c).backgroundImage,j.split(",").length>1){throw"Multiple backgrounds are not supported"}if(!j||"none"===j){throw"Element is not an <img> but does not have a background-image"}i[h]={img:new Image,el:i[h]},j=j.slice(4,-1),j=j.replace(/"/g,""),i[h].img.src=j,an("CSS Image - "+j)}}return i}function aj(e,d){var f=e;if("string"==typeof e?f=document.querySelectorAll(e):e&&1===e.nodeType&&(f=[e]),!f||0===f.length||void 0===f.length){throw"Elements not found"}return d&&(f=ak(f)),f=Array.prototype.slice.call(f)}function ai(){V=document.createElement("canvas"),V&&V.getContext?(T=V.getContext("2d"),X=!0):X=!1,ah()}function ah(){I("debugOverlay")?(V.style.opacity=0.5,V.style.pointerEvents="none",document.body.appendChild(V)):V.parentNode&&V.parentNode.removeChild(V)}function ag(b){var c=(new Date).getTime()-b;an("Duration: "+c+"ms"),c>I("maxDuration")&&(console.log("BackgroundCheck - Killed"),Y(),ao())}function af(){P={left:0,top:0,right:document.body.clientWidth,bottom:window.innerHeight},V.width=document.body.clientWidth,V.height=window.innerHeight}function ae(g,f,j){var i,h;return -1!==g.indexOf("px")?i=parseFloat(g):-1!==g.indexOf("%")?(i=parseFloat(g),h=i/100,i=h*f,j&&(i-=j*h)):i=f,i}function ad(t){var s=window.getComputedStyle(t.el);t.el.style.backgroundRepeat="no-repeat",t.el.style.backgroundOrigin="padding-box";var r=s.backgroundSize.split(" "),q=r[0],p=void 0===r[1]?"auto":r[1],o=t.el.clientWidth/t.el.clientHeight,n=t.img.naturalWidth/t.img.naturalHeight;"cover"===q?o>=n?(q="100%",p="auto"):(q="auto",r[0]="auto",p="100%"):"contain"===q&&(1/n>1/o?(q="auto",r[0]="auto",p="100%"):(q="100%",p="auto")),q="auto"===q?t.img.naturalWidth:ae(q,t.el.clientWidth),p="auto"===p?q/t.img.naturalWidth*t.img.naturalHeight:ae(p,t.el.clientHeight),"auto"===r[0]&&"auto"!==r[1]&&(q=p/t.img.naturalHeight*t.img.naturalWidth);var m=s.backgroundPosition;"top"===m?m="50% 0%":"left"===m?m="0% 50%":"right"===m?m="100% 50%":"bottom"===m?m="50% 100%":"center"===m&&(m="50% 50%"),m=m.split(" ");var l,k;return 4===m.length?(l=m[1],k=m[3]):(l=m[0],k=m[1]),k=k||"50%",l=ae(l,t.el.clientWidth,q),k=ae(k,t.el.clientHeight,p),4===m.length&&("right"===m[0]&&(l=t.el.clientWidth-t.img.naturalWidth-l),"bottom"===m[2]&&(k=t.el.clientHeight-t.img.naturalHeight-k)),l+=t.el.getBoundingClientRect().left,k+=t.el.getBoundingClientRect().top,{left:Math.floor(l),right:Math.floor(l+q),top:Math.floor(k),bottom:Math.floor(k+p),width:Math.floor(q),height:Math.floor(p)}}function ac(i){var h,n,m;if(i.nodeType){var l=i.getBoundingClientRect();h={left:l.left,right:l.right,top:l.top,bottom:l.bottom,width:l.width,height:l.height},m=i.parentNode,n=i}else{h=ad(i),m=i.el,n=i.img}m=m.getBoundingClientRect(),h.imageTop=0,h.imageLeft=0,h.imageWidth=n.naturalWidth,h.imageHeight=n.naturalHeight;var k,j=h.imageHeight/h.height;return h.top<m.top&&(k=m.top-h.top,h.imageTop=j*k,h.imageHeight-=j*k,h.top+=k,h.height-=k),h.left<m.left&&(k=m.left-h.left,h.imageLeft+=j*k,h.imageWidth-=j*k,h.width-=k,h.left+=k),h.bottom>m.bottom&&(k=h.bottom-m.bottom,h.imageHeight-=j*k,h.height-=k),h.right>m.right&&(k=h.right-m.right,h.imageWidth-=j*k,h.width-=k),h.imageTop=Math.floor(h.imageTop),h.imageLeft=Math.floor(h.imageLeft),h.imageHeight=Math.floor(h.imageHeight),h.imageWidth=Math.floor(h.imageWidth),h}function ab(d){var c=ac(d);d=d.nodeType?d:d.img,c.imageWidth>0&&c.imageHeight>0&&c.width>0&&c.height>0?T.drawImage(d,c.imageLeft,c.imageTop,c.imageWidth,c.imageHeight,c.left,c.top,c.width,c.height):an("Skipping image - "+d.src+" - area too small")}function aa(g,f,j){var i=g.className;switch(j){case"add":i+=" "+f;break;case"remove":var h=new RegExp("(?:^|\\s)"+f+"(?!\\S)","g");i=i.replace(h,"")}g.className=i.trim()}function Y(f){for(var e,h=f?[f]:I("targets"),g=0;g<h.length;g++){e=h[g],e=I("changeParent")?e.parentNode:e,aa(e,I("classes").light,"remove"),aa(e,I("classes").dark,"remove"),aa(e,I("classes").complex,"remove")}}function W(x){var w,v,u,t,s=x.getBoundingClientRect(),r=0,q=0,p=0,o=0,n=I("mask");if(s.width>0&&s.height>0){Y(x),x=I("changeParent")?x.parentNode:x,v=T.getImageData(s.left,s.top,s.width,s.height).data;for(var c=0;c<v.length;c+=4){v[c]===n.r&&v[c+1]===n.g&&v[c+2]===n.b?o++:(r++,w=0.2126*v[c]+0.7152*v[c+1]+0.0722*v[c+2],u=w-p,q+=u*u,p+=u/r)}o<=v.length/4*(1-I("minOverlap")/100)&&(t=Math.sqrt(q/r)/255,p/=255,an("Target: "+x.className+" lum: "+p+" var: "+t),aa(x,p<=I("threshold")/100?I("classes").dark:I("classes").light,"add"),t>I("minComplexity")/100&&aa(x,I("classes").complex,"add"))}}function U(d,c){return d=(d.nodeType?d:d.el).getBoundingClientRect(),c=c===P?c:(c.nodeType?c:c.el).getBoundingClientRect(),!(d.right<c.left||d.left>c.right||d.top>c.bottom||d.bottom<c.top)}function S(i){for(var h,n=(new Date).getTime(),m=i&&("IMG"===i.tagName||i.img)?"image":"targets",l=i?!1:!0,k=I("targets").length,j=0;k>j;j++){h=I("targets")[j],U(h,P)&&("targets"!==m||i&&i!==h?"image"===m&&U(h,i)&&W(h):(l=!0,W(h)))}if("targets"===m&&!l){throw i+" is not a target"}ag(n)}function Q(g){var f=function(d){var c=0;return"static"!==window.getComputedStyle(d).position&&(c=parseInt(window.getComputedStyle(d).zIndex,10)||0,c>=0&&c++),c},j=g.parentNode,i=j?f(j):0,h=f(g);return 100000*i+h}function O(d){var c=!1;return d.sort(function(b,h){b=b.nodeType?b:b.el,h=h.nodeType?h:h.el;var g=b.compareDocumentPosition(h),f=0;return b=Q(b),h=Q(h),b>h&&(c=!0),b===h&&2===g?f=1:b===h&&4===g&&(f=-1),f||b-h}),an("Sorted: "+c),c&&an(d),c}function M(t,s,r){if(X){var q=I("mask");an("--- BackgroundCheck ---"),an("onLoad event: "+(r&&r.src)),s!==!0&&(T.clearRect(0,0,V.width,V.height),T.fillStyle="rgb("+q.r+", "+q.g+", "+q.b+")",T.fillRect(0,0,V.width,V.height));for(var p,o,n=r?[r]:I("images"),m=O(n),l=!1,c=0;c<n.length;c++){p=n[c],U(p,P)&&(o=p.nodeType?p:p.img,0===o.naturalWidth?(l=!0,an("Loading... "+p.src),o.removeEventListener("load",M),m?o.addEventListener("load",M.bind(null,null,!1,null)):o.addEventListener("load",M.bind(null,t,!0,p))):(an("Drawing: "+p.src),ab(p)))}r||l?r&&S(r):S(t)}}function K(b){I("windowEvents")===!0&&(R&&clearTimeout(R),R=setTimeout(b,200))}function J(e,d){if(void 0===L[e]){throw"Unknown property - "+e}if(void 0===d){throw"Missing value for "+e}if("targets"===e||"images"===e){try{d=aj("images"!==e||d?d:"img","images"===e?!0:!1)}catch(f){throw d=[],f}}else{al(d,typeof L[e])}Y(),L[e]=d,M(),"debugOverlay"===e&&ah()}function I(b){if(void 0===L[b]){throw"Unknown property - "+b}return L[b]}function Z(){for(var f,e=I("images"),h=[],g=0;g<e.length;g++){f=ac(e[g]),h.push(f)}return h}var X,V,T,R,P,N=void 0!==window.orientation?"orientationchange":"resize",L={};return{init:ap,destroy:ao,refresh:M,set:J,get:I,getImageData:Z}});